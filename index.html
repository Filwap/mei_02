<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>赠与bb🐷的一封情书</title>
    <link rel="icon" type="image/x-icon" href="https://i.loli.net/2021/06/03/lFg2V4WUcmkB98G.png">
    <meta name="language" content="zh-CN">
    <meta name="title" content="小梅同学">
    <style>
        @media screen and (max-width: 428px) {
            #main {
                width: 100% !important;
                height: 100vh !important;
                overflow: hidden;
            }
            #wrap {
                width: 100% !important;
                height: 100vh !important;
                margin-top: 0 !important;
            }
            #text {
                width: 90% !important;
                height: auto !important;
                left: 5% !important;
                top: 50px !important;
                z-index: 2;
            }
            #code {
                font-size: 18px !important;
                line-height: 1.6 !important;
                background: rgba(255, 255, 255, 0.85) !important;
                padding: 20px !important;
                border-radius: 15px !important;
            }
            .say {
                font-size: 20px !important;
                margin-bottom: 10px !important;
                display: block !important;
            }
            #clock-box {
                width: 90% !important;
                left: 5% !important;
                bottom: 30px !important;
                top: auto !important;
                font-size: 16px !important;
                background: rgba(255, 255, 255, 0.85) !important;
                padding: 15px !important;
                border-radius: 15px !important;
                text-align: center !important;
            }
            #clock {
                margin-left: 0 !important;
                font-size: 24px !important;
            }
            #canvas {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                z-index: 1 !important;
            }
            .space {
                margin-right: 0 !important;
            }
        }
    </style>
    <link type="text/css" rel="stylesheet" href="./Love_files/default.css">
    <script type="text/javascript" src="./Love_files/jquery.min.js"></script>
    <script type="text/javascript" src="./Love_files/jscex.min.js"></script>
    <script type="text/javascript" src="./Love_files/jscex-parser.js"></script>
    <script type="text/javascript" src="./Love_files/jscex-jit.js"></script>
    <script type="text/javascript" src="./Love_files/jscex-builderbase.min.js"></script>
    <script type="text/javascript" src="./Love_files/jscex-async.min.js"></script>
    <script type="text/javascript" src="./Love_files/jscex-async-powerpack.min.js"></script>
    <script type="text/javascript" src="./Love_files/functions.js" charset="utf-8"></script>
    <script type="text/javascript" src="./Love_files/love.js" charset="utf-8"></script>

</head>

<body>
    <div id="main">
        <div id="error">亲，您使用的浏览器无法支持即将显示的内容，请换成谷歌(<a
                href="http://www.google.cn/chrome/intl/zh-CN/landing_chrome.html?hl=zh-CN&brand=CHMI">Chrome</a>)或者火狐(<a
                href="http://firefox.com.cn/download/">Firefox</a>)浏览器哟~</div>
        <div id="wrap">
            <div id="text">
                <div id="code">
                    <span class="say">Dear bb🐷</span><br><br>
                    <span class="say">玫瑰送你才浪漫</span><br>
                    <span class="say">日落和你才好看</span><br>
                    <span class="say">是微风</span><br>
                    <span class="say">是晚霞</span><br>
                    <br>
                    <span class="say">是心跳不止</span><br>
                    <span class="say">是无可替代</span><br>
                    <span class="say">没别的意思</span><br>
                    <span class="say">就是借着特殊的日子</span><br>
                    <span class="say">说声我爱你❤</span><br>
                    <br>
                    <span class="say">在这个爱意随风起的年代</span><br>
                    <span class="say">我想和你慢慢来</span><br>
                    <span class="say">希望我们永远是彼此的底气</span><br>
                    <span class="say">被爱、被惦记、被理解</span><br>
                    <span class="say">永远是人生三大幸事❤</span><br>
                    <br>
                    <span class="say"><span class="space"></span> -- Your 小狗</span>
                </div>
            </div>
            <div id="clock-box">
                <a href="www.haomei.fun" target="_blank">小猫</a> 和 <a href="www.haomei.fun"
                    target="_blank">小狗</a> 在一起的
                <div id="clock"></div>
            </div>
            <canvas id="canvas" width="1100" height="680"></canvas>
        </div>

    </div>

    <!-- 音频将通过JavaScript动态加载 -->
    <audio id="media" loop></audio>
    
    <div id="loading" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
         background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 10px; 
         text-align: center; display: none; z-index: 999;">
        加载中... <span id="progress">0</span>%
    </div>
    
    <script>
        // 音乐控制相关代码
        document.addEventListener('DOMContentLoaded', function() {
            var audio = document.getElementById('media');
            var loadingDiv = document.getElementById('loading');
            var progressSpan = document.getElementById('progress');
            
            // 延迟加载音频
            function loadAudio() {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', 'CMJ - 星星在唱歌（纯音乐）.mp3', true);
                xhr.responseType = 'blob';
                
                xhr.onprogress = function(e) {
                    if (e.lengthComputable) {
                        var percentComplete = Math.round((e.loaded / e.total) * 100);
                        progressSpan.textContent = percentComplete;
                    }
                };
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        var blob = xhr.response;
                        var url = URL.createObjectURL(blob);
                        audio.src = url;
                        loadingDiv.style.display = 'none';
                    }
                };
                
                xhr.send();
            }
            
            // 当用户点击页面时加载音频
            document.addEventListener('click', function loadOnFirstClick() {
                loadingDiv.style.display = 'block';
                loadAudio();
                document.removeEventListener('click', loadOnFirstClick);
            }, { once: true });
            
            // 检测是否是微信浏览器
            function isWechat() {
                var ua = navigator.userAgent.toLowerCase();
                return ua.match(/MicroMessenger/i) == "micromessenger";
            }
            
            // 确保音频循环播放
            audio.loop = true;
            
            // 监听音频结束事件，确保循环播放
            audio.addEventListener('ended', function() {
                this.currentTime = 0;
                this.play();
            }, false);
            
            // 尝试自动播放音乐
            function attemptAutoplay() {
                // 尝试播放
                audio.play().then(function() {
                    console.log('自动播放成功');
                }).catch(function(err) {
                    console.log('自动播放失败:', err);
                    
                    // 如果自动播放失败，尝试使用微信JSSDK（如果在微信中）
                    if (isWechat() && typeof WeixinJSBridge !== 'undefined') {
                        WeixinJSBridge.invoke('getNetworkType', {}, function(e) {
                            audio.play();
                        });
                    } else {
                        // 创建一个一次性的触摸事件监听器
                        document.addEventListener('touchstart', function playOnTouch() {
                            audio.play();
                            document.removeEventListener('touchstart', playOnTouch);
                        }, { once: true });
                    }
                });
            }
            
            // 监听WeixinJSBridge准备就绪
            if (isWechat()) {
                if (typeof WeixinJSBridge === 'undefined') {
                    document.addEventListener('WeixinJSBridgeReady', attemptAutoplay, false);
                } else {
                    attemptAutoplay();
                }
            } else {
                attemptAutoplay();
            }
            
            // 添加页面可见性变化监听，解决页面切换后音乐停止的问题
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && !audio.paused) {
                    audio.play();
                }
            });
        });

        (function () {
            var canvas = $('#canvas');

            if (!canvas[0].getContext) {
                $("#error").show();
                return false;
            }

            // 根据设备调整画布大小
            var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            var width = isMobile ? window.innerWidth : canvas.width();
            var height = isMobile ? window.innerHeight : canvas.height();
            
            // 设置画布尺寸
            canvas.attr("width", width);
            canvas.attr("height", height);
            
            // 监听窗口大小变化
            $(window).resize(function() {
                if(isMobile) {
                    canvas.attr("width", window.innerWidth);
                    canvas.attr("height", window.innerHeight);
                }
            });

            // 检测是否为移动设备
            var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            // 计算缩放比例
            var scale = isMobile ? 0.6 : 1;
            var centerX = width / 2;
            var bottomY = height - height * 0.1;

            var opts = {
                seed: {
                    x: centerX,
                    color: "rgb(190, 26, 37)",
                    scale: 2 * scale
                },
                branch: [
                    // 使用相对位置计算，适应不同屏幕大小
                    [centerX + 35 * scale, height - 20, 
                     centerX + 70 * scale, height/3, 
                     centerX, height/4, 
                     30 * scale, 100, [
                        [centerX + 40 * scale, height/1.5, 
                         centerX - 45 * scale, height/1.8, 
                         centerX - 160 * scale, height/1.8, 
                         13 * scale, 100, [
                            [centerX - 50 * scale, height/1.7, 
                             centerX - 66 * scale, height/1.7, 
                             centerX - 106 * scale, height/1.8, 
                             2 * scale, 40]
                        ]],
                        [centerX + 50 * scale, height/1.6, 
                         centerX + 100 * scale, height/2.2, 
                         centerX + 180 * scale, height/2.2, 
                         12 * scale, 100, [
                            [centerX + 78 * scale, height/1.8, 
                             centerX + 148 * scale, height/1.7, 
                             centerX + 161 * scale, height/1.7, 
                             3 * scale, 80]
                        ]],
                        [centerX + 39 * scale, height/2.7, 
                         centerX + 37 * scale, height/3, 
                         centerX + 34 * scale, height/3.5, 
                         3 * scale, 40],
                        [centerX + 46 * scale, height/1.8, 
                         centerX - 87 * scale, height/3, 
                         centerX - 172 * scale, height/3, 
                         9 * scale, 80, [
                            [centerX - 73 * scale, height/2.5, 
                             centerX - 117 * scale, height/3, 
                             centerX - 129 * scale, height/3.7, 
                             2 * scale, 40],
                            [centerX - 2 * scale, height/2.2, 
                             centerX - 65 * scale, height/2.3, 
                             centerX - 105 * scale, height/2.2, 
                             4 * scale, 60]
                        ]],
                        [centerX + 46 * scale, height/2.1, 
                         centerX + 108 * scale, height/3, 
                         centerX + 178 * scale, height/3.4, 
                         6 * scale, 100, [
                            [centerX + 90 * scale, height/2.4, 
                             centerX + 146 * scale, height/2.6, 
                             centerX + 148 * scale, height/2.7, 
                             2 * scale, 80]
                        ]]
                    ]]
                ],
                bloom: {
                    num: isMobile ? 350 : 700, // 移动设备上减少花瓣数量
                    width: width,
                    height: height * 0.9,
                },
                footer: {
                    width: width,
                    height: 5,
                    speed: isMobile ? 10 : 20, // 移动设备上降低速度
                }
            }

            var tree = new Tree(canvas[0], width, height, opts);
            var seed = tree.seed;
            var foot = tree.footer;
            var hold = 1;

            canvas.click(function (e) {
                var offset = canvas.offset(), x, y;
                x = e.pageX - offset.left;
                y = e.pageY - offset.top;
                if (seed.hover(x, y)) {
                    hold = 0;
                    canvas.unbind("click");
                    canvas.unbind("mousemove");
                    canvas.removeClass('hand');
                    
                    // 点击信封后播放背景音乐
                    var audio = document.getElementById('media');
                    audio.play().catch(function(err) {
                        console.log('播放失败:', err);
                    });
                }
            }).mousemove(function (e) {
                var offset = canvas.offset(), x, y;
                x = e.pageX - offset.left;
                y = e.pageY - offset.top;
                canvas.toggleClass('hand', seed.hover(x, y));
            });

            var seedAnimate = eval(Jscex.compile("async", function () {
                seed.draw();
                while (hold) {
                    $await(Jscex.Async.sleep(10));
                }
                while (seed.canScale()) {
                    seed.scale(0.95);
                    $await(Jscex.Async.sleep(10));
                }
                while (seed.canMove()) {
                    seed.move(0, 2);
                    foot.draw();
                    $await(Jscex.Async.sleep(10));
                }
            }));

            var growAnimate = eval(Jscex.compile("async", function () {
                do {
                    tree.grow();
                    $await(Jscex.Async.sleep(10));
                } while (tree.canGrow());
            }));

            var flowAnimate = eval(Jscex.compile("async", function () {
                do {
                    tree.flower(2);
                    $await(Jscex.Async.sleep(10));
                } while (tree.canFlower());
            }));

            var moveAnimate = eval(Jscex.compile("async", function () {
                tree.snapshot("p1", 240, 0, 610, 680);
                while (tree.move("p1", 500, 0)) {
                    foot.draw();
                    $await(Jscex.Async.sleep(10));
                }
                foot.draw();
                tree.snapshot("p2", 500, 0, 610, 680);

                // 会有闪烁不得意这样做, (＞﹏＜)
                canvas.parent().css("background", "url(" + tree.toDataURL('image/png') + ")");
                canvas.css("background", "#ffc0cb");
                $await(Jscex.Async.sleep(300));
                canvas.css("background", "none");
            }));

            var jumpAnimate = eval(Jscex.compile("async", function () {
                var ctx = tree.ctx;
                while (true) {
                    tree.ctx.clearRect(0, 0, width, height);
                    tree.jump();
                    foot.draw();
                    $await(Jscex.Async.sleep(25));
                }
            }));

            var textAnimate = eval(Jscex.compile("async", function () {
                var together = new Date();
                together.setFullYear(2025, 3, 17);
                together.setHours(0);
                together.setMinutes(0);
                together.setSeconds(0);
                together.setMilliseconds(0);

                $("#code").show().typewriter();
                $("#clock-box").fadeIn(500);
                while (true) {
                    timeElapse(together);
                    $await(Jscex.Async.sleep(1000));
                }
            }));

            var runAsync = eval(Jscex.compile("async", function () {
                $await(seedAnimate());
                $await(growAnimate());
                $await(flowAnimate());
                $await(moveAnimate());

                textAnimate().start();

                $await(jumpAnimate());
            }));

            runAsync().start();
        })();
    </script>



    <!-- 添加移动设备适配样式 -->
    <style>
        @media screen and (max-width: 428px) {
            body {
                font-size: 16px;
                margin: 0;
                padding: 0;
                overflow-x: hidden;
            }

            #main {
                width: 100% !important;
                height: 100vh !important;
            }

            #wrap {
                width: 100% !important;
                height: 100vh !important;
                margin: 0 !important;
                position: relative !important;
            }

            #text {
                width: 90% !important;
                height: auto !important;
                left: 5% !important;
                top: 50px !important;
                position: absolute !important;
                z-index: 2 !important;
            }

            #code {
                font-size: 18px !important;
                line-height: 1.6 !important;
                padding: 20px !important;
                background: rgba(255, 255, 255, 0.85) !important;
                border-radius: 15px !important;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
                margin: 0 auto !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }

            .say {
                font-size: 20px !important;
                margin-bottom: 15px !important;
                color: #333 !important;
                font-weight: 500 !important;
            }

            #clock-box {
                width: 90% !important;
                left: 5% !important;
                bottom: 30px !important;
                top: auto !important;
                position: fixed !important;
                z-index: 2 !important;
                background: rgba(255, 255, 255, 0.85) !important;
                padding: 15px !important;
                border-radius: 15px !important;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
                text-align: center !important;
                box-sizing: border-box !important;
            }

            #clock {
                margin: 0 auto !important;
                font-size: 24px !important;
                text-align: center !important;
            }

            #canvas {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                z-index: 1 !important;
            }

            .space {
                margin-right: 0 !important;
            }

            #loading {
                z-index: 9999 !important;
            }
        }
    </style>
</body>

</html>